"use strict";(()=>{var e={};e.id=939,e.ids=[939],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},2753:(e,t,r)=>{r.r(t),r.d(t,{config:()=>h,default:()=>f,routeModule:()=>P});var o={};r.r(o),r.d(o,{default:()=>l});var n=r(1802),a=r(7153),s=r(6249),i=r(2885),u=r(8083);let d=(0,i.createClient)(process.env.SUPABASE_URL,process.env.SUPABASE_ANON_KEY);async function c(e,t){if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),t.setHeader("Access-Control-Allow-Credentials","true"),"OPTIONS"===e.method)return t.status(200).end();if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{count:e}=await d.from("products").select("*",{count:"exact",head:!0}),{data:r,error:o}=await d.from("orders").select("*");if(o)throw o;let{data:n}=await d.from("products").select("id, cost, price, name"),a={};(n||[]).forEach(e=>{a[e.id]=e});let s=r||[],i=new Date,u=new Date(i.getFullYear(),i.getMonth(),i.getDate()),c=new Date(i.getTime()-6048e5),l=new Date(i.getFullYear(),i.getMonth(),1),f=0,h=0,P=0,m=0,p=0,A=0,M=0,y=0,E=0,g=0,v=0,w=0;s.forEach(e=>{let t=new Date(e.created_at),r=e.total||0,o=0;e.items&&Array.isArray(e.items)&&e.items.forEach(e=>{let t=a[e.id];t?.cost&&(o+=t.cost*e.quantity)}),f+=r,h+=o,t>=u&&(P++,m+=r,p+=o),t>=c&&(A+=r,M+=o),t>=l&&(y+=r,E+=o),"pending"===e.status&&g++,"confirmed"===e.status&&v++,"completed"===e.status&&w++});let b=f-h,O=m-p,_=A-M,j=y-E,q=f>0?b/f*100:0,C=m>0?O/m*100:0,S=A>0?_/A*100:0,k=y>0?j/y*100:0,T={};s.forEach(e=>{"completed"===e.status&&e.items&&e.items.forEach(e=>{T[e.id]||(T[e.id]={id:e.id,name:a[e.id]?.name||e.name,quantity:0,revenue:0,cost:0}),T[e.id].quantity+=e.quantity,T[e.id].revenue+=(a[e.id]?.price||0)*e.quantity,T[e.id].cost+=(a[e.id]?.cost||0)*e.quantity})});let x=Object.values(T).map(e=>({...e,profit:e.revenue-e.cost})).sort((e,t)=>t.quantity-e.quantity).slice(0,5);return t.status(200).json({totalProducts:e||0,totalOrders:s.length,totalRevenue:Math.round(f),totalCost:Math.round(h),totalProfit:Math.round(b),totalProfitMargin:Math.round(10*q)/10,todayOrders:P,todayRevenue:Math.round(m),todayCost:Math.round(p),todayProfit:Math.round(O),todayProfitMargin:Math.round(10*C)/10,weekRevenue:Math.round(A),weekCost:Math.round(M),weekProfit:Math.round(_),weekProfitMargin:Math.round(10*S)/10,monthRevenue:Math.round(y),monthCost:Math.round(E),monthProfit:Math.round(j),monthProfitMargin:Math.round(10*k)/10,pendingOrders:g,confirmedOrders:v,completedOrders:w,topProducts:x})}catch(e){return console.error("Stats API Error:",e),t.status(500).json({error:e.message})}}let l=(0,u.mk)(c),f=(0,s.l)(o,"default"),h=(0,s.l)(o,"config"),P=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/stats",pathname:"/api/stats",bundlePath:"",filename:""},userland:o})},8083:(e,t,r)=>{r.d(t,{V3:()=>s,mk:()=>u,WX:()=>i});let o=require("jsonwebtoken");var n=r.n(o);let a=process.env.JWT_SECRET||"f4a508a5eeba6ca9b9aab345bfe21699013fbecff93ee4d7bf80be15cfb84b3f";function s(e){return n().sign(e,a,{expiresIn:"24h"})}function i(e){try{return n().verify(e,a)}catch(e){return null}}function u(e){return async(t,r)=>{try{let o=t.cookies?.auth_token||t.headers.authorization?.replace("Bearer ","");if(!o)return r.status(401).json({error:"Authentication required",code:"NO_TOKEN"});let n=i(o);if(!n)return r.status(401).json({error:"Invalid or expired token",code:"INVALID_TOKEN"});return t.user=n,e(t,r)}catch(e){return console.error("Auth middleware error:",e),r.status(500).json({error:"Authentication error"})}}}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=2753);module.exports=r})();