"use strict";(()=>{var e={};e.id=722,e.ids=[722],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},7959:(e,r,t)=>{t.r(r),t.d(r,{config:()=>m,default:()=>f,routeModule:()=>p});var o={};t.r(o),t.d(o,{default:()=>l});var n=t(1802),s=t(7153),a=t(6249),i=t(2885),u=t(8083);let d=(0,i.createClient)(process.env.SUPABASE_URL,process.env.SUPABASE_ANON_KEY);function c(e){let r=e.cookies?.auth_token||e.headers.authorization?.replace("Bearer ","");return!!r&&null!==(0,u.WX)(r)}let l=async function(e,r){if(r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","GET, POST, PUT, PATCH, OPTIONS"),r.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),r.setHeader("Access-Control-Allow-Credentials","true"),"OPTIONS"===e.method)return r.status(200).end();try{if("GET"===e.method){if(!c(e))return r.status(401).json({error:"Authentication required",code:"AUTH_REQUIRED"});let{status:t,id:o}=e.query,n=d.from("orders").select("*");o&&(n=n.eq("id",o)),t&&(n=n.eq("status",t)),n=n.order("created_at",{ascending:!1});let{data:s,error:a}=await n;if(a)throw a;let i=await Promise.all((s||[]).map(async e=>{let r=0;if(e.items&&Array.isArray(e.items))for(let t of e.items){let{data:e}=await d.from("products").select("cost").eq("id",t.id).single();e?.cost&&(r+=e.cost*t.quantity)}let t=e.total-r;return{...e,cost:r,profit:t}}));return r.status(200).json(i)}if("POST"===e.method){let{data:t}=await d.from("orders").select("order_number").order("order_number",{ascending:!1}).limit(1).single(),o=(t?.order_number||1e3)+1,{data:n,error:s}=await d.from("orders").insert([{order_number:o,items:e.body.items,total:e.body.total,status:"pending",customer_name:e.body.customerName||"Cliente Online",customer_phone:e.body.customerPhone||"Via WhatsApp",notes:e.body.notes||""}]).select().single();if(s)throw s;return r.status(200).json({success:!0,order:{...n,orderNumber:n.order_number,date:n.created_at}})}if("PUT"===e.method||"PATCH"===e.method){if(!c(e))return r.status(401).json({error:"Authentication required",code:"AUTH_REQUIRED"});let{id:t}=e.query;if(!t)return r.status(400).json({error:"Order ID required"});let{status:o,notes:n}=e.body;if(o&&!["pending","confirmed","completed","cancelled"].includes(o))return r.status(400).json({error:"Invalid status. Must be: pending, confirmed, completed, or cancelled"});let s={};o&&(s.status=o),void 0!==n&&(s.notes=n),"confirmed"===o&&(s.confirmed_at=new Date().toISOString()),"completed"===o&&(s.completed_at=new Date().toISOString());let{data:a,error:i}=await d.from("orders").update(s).eq("id",t).select().single();if(i)throw i;return r.status(200).json({success:!0,order:a,message:`Order ${o?`marked as ${o}`:"updated"}`})}return r.status(405).json({error:"Method not allowed"})}catch(e){return console.error("Orders API Error:",e),r.status(500).json({error:e.message})}},f=(0,a.l)(o,"default"),m=(0,a.l)(o,"config"),p=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/orders",pathname:"/api/orders",bundlePath:"",filename:""},userland:o})},8083:(e,r,t)=>{t.d(r,{V3:()=>a,mk:()=>u,WX:()=>i});let o=require("jsonwebtoken");var n=t.n(o);let s=process.env.JWT_SECRET||"f4a508a5eeba6ca9b9aab345bfe21699013fbecff93ee4d7bf80be15cfb84b3f";function a(e){return n().sign(e,s,{expiresIn:"24h"})}function i(e){try{return n().verify(e,s)}catch(e){return null}}function u(e){return async(r,t)=>{try{let o=r.cookies?.auth_token||r.headers.authorization?.replace("Bearer ","");if(!o)return t.status(401).json({error:"Authentication required",code:"NO_TOKEN"});let n=i(o);if(!n)return t.status(401).json({error:"Invalid or expired token",code:"INVALID_TOKEN"});return r.user=n,e(r,t)}catch(e){return console.error("Auth middleware error:",e),t.status(500).json({error:"Authentication error"})}}}},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var t=r(r.s=7959);module.exports=t})();